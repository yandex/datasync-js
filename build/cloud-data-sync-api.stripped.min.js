!function(e){var t={cloud:{},vow:e.ya&&e.ya.vow||e.vow,modules:e.ya&&e.ya.modules||e.modules};t.modules.define("vow",function(e){e(t.vow)}),function(t){var n={exports:{}},i={},r=t.vow.Promise;!function(t){if("object"==typeof i&&"undefined"!=typeof n)n.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r;r="undefined"!=typeof window?window:"undefined"!=typeof e?e:"undefined"!=typeof self?self:this,r.localforage=t()}}(function(){return function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(o)return o(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var l=n[a]={exports:{}};t[a][0].call(l.exports,function(e){var n=t[a][1][e];return r(n?n:e)},l,l.exports,e,t,n,i)}return n[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t,n){"use strict";function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}function a(){try{if(!fe)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&fetch.toString().indexOf("[native code")!==-1;return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(n){return!1}}function s(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(n){if("TypeError"!==n.name)throw n;for(var i="undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder,r=new i,o=0;o<e.length;o+=1)r.append(e[o]);return r.getBlob(t.type)}}function c(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}function u(e,t,n){"function"==typeof t&&e.then(t),"function"==typeof n&&e["catch"](n)}function l(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function d(e){for(var t=e.length,n=new ArrayBuffer(t),i=new Uint8Array(n),r=0;r<t;r++)i[r]=e.charCodeAt(r);return n}function f(e){return new pe(function(t){var n=e.transaction(ve,ge),i=s([""]);n.objectStore(ve).put(i,"key"),n.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},n.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);t(n||!e||parseInt(e[1],10)>=43)}})["catch"](function(){return!1})}function h(e){return"boolean"==typeof he?pe.resolve(he):f(e).then(function(e){return he=e})}function _(e){var t=_e[e.name],n={};n.promise=new pe(function(e){n.resolve=e}),t.deferredOperations.push(n),t.dbReady?t.dbReady=t.dbReady.then(function(){return n.promise}):t.dbReady=n.promise}function p(e){var t=_e[e.name],n=t.deferredOperations.pop();n&&n.resolve()}function v(e,t){var n=_e[e.name],i=n.deferredOperations.pop();i&&i.reject(t)}function y(e,t){return new pe(function(n,i){if(e.db){if(!t)return n(e.db);_(e),e.db.close()}var r=[e.name];t&&r.push(e.version);var o=fe.open.apply(fe,r);t&&(o.onupgradeneeded=function(t){var n=o.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore(ve)}catch(i){if("ConstraintError"!==i.name)throw i;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),o.onerror=function(e){e.preventDefault(),i(o.error)},o.onsuccess=function(){n(o.result),p(e)}})}function b(e){return y(e,!1)}function g(e){return y(e,!0)}function m(e,t){if(!e.db)return!0;var n=!e.db.objectStoreNames.contains(e.storeName),i=e.version<e.db.version,r=e.version>e.db.version;if(i&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),r||n){if(n){var o=e.db.version+1;o>e.version&&(e.version=o)}return!0}return!1}function w(e){return new pe(function(t,n){var i=new FileReader;i.onerror=n,i.onloadend=function(n){var i=btoa(n.target.result||"");t({__local_forage_encoded_blob:!0,data:i,type:e.type})},i.readAsBinaryString(e)})}function I(e){var t=d(atob(e.data));return s([t],{type:e.type})}function S(e){return e&&e.__local_forage_encoded_blob}function k(e){var t=this,n=t._initReady().then(function(){var e=_e[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady});return u(n,e,e),n}function x(e){_(e);for(var t=_e[e.name],n=t.forages,i=0;i<n.length;i++)n[i]._dbInfo.db&&(n[i]._dbInfo.db.close(),n[i]._dbInfo.db=null);return y(e,!1).then(function(e){for(var t=0;t<n.length;t++)n[t]._dbInfo.db=e})["catch"](function(t){throw v(e,t),t})}function A(e,t,n){try{var i=e.db.transaction(e.storeName,t);n(null,i)}catch(r){if(!e.db||"InvalidStateError"===r.name)return x(e).then(function(){var i=e.db.transaction(e.storeName,t);n(null,i)});n(r)}}function C(e){function t(){return pe.resolve()}var n=this,i={db:null};if(e)for(var r in e)i[r]=e[r];_e||(_e={});var o=_e[i.name];o||(o={forages:[],db:null,dbReady:null,deferredOperations:[]},_e[i.name]=o),o.forages.push(n),n._initReady||(n._initReady=n.ready,n.ready=k);for(var a=[],s=0;s<o.forages.length;s++){var c=o.forages[s];c!==n&&a.push(c._initReady()["catch"](t))}var u=o.forages.slice(0);return pe.all(a).then(function(){return i.db=o.db,b(i)}).then(function(e){return i.db=e,m(i,n._defaultConfig.version)?g(i):e}).then(function(e){i.db=o.db=e,n._dbInfo=i;for(var t=0;t<u.length;t++){var r=u[t];r!==n&&(r._dbInfo.db=i.db,r._dbInfo.version=i.version)}})}function E(e,t){var n=this;e=l(e);var i=new pe(function(t,i){n.ready().then(function(){A(n._dbInfo,be,function(r,o){if(r)return i(r);try{var a=o.objectStore(n._dbInfo.storeName),s=a.get(e);s.onsuccess=function(){var e=s.result;void 0===e&&(e=null),S(e)&&(e=I(e)),t(e)},s.onerror=function(){i(s.error)}}catch(c){i(c)}})})["catch"](i)});return c(i,t),i}function D(e,t){var n=this,i=new pe(function(t,i){n.ready().then(function(){A(n._dbInfo,be,function(r,o){if(r)return i(r);try{var a=o.objectStore(n._dbInfo.storeName),s=a.openCursor(),c=1;s.onsuccess=function(){var n=s.result;if(n){var i=n.value;S(i)&&(i=I(i));var r=e(i,n.key,c++);void 0!==r?t(r):n["continue"]()}else t()},s.onerror=function(){i(s.error)}}catch(u){i(u)}})})["catch"](i)});return c(i,t),i}function R(e,t,n){var i=this;e=l(e);var r=new pe(function(n,r){var o;i.ready().then(function(){return o=i._dbInfo,"[object Blob]"===ye.call(t)?h(o.db).then(function(e){return e?t:w(t)}):t}).then(function(t){A(i._dbInfo,ge,function(o,a){if(o)return r(o);try{var s=a.objectStore(i._dbInfo.storeName);null===t&&(t=void 0);var c=s.put(t,e);a.oncomplete=function(){void 0===t&&(t=null),n(t)},a.onabort=a.onerror=function(){var e=c.error?c.error:c.transaction.error;r(e)}}catch(u){r(u)}})})["catch"](r)});return c(r,n),r}function O(e,t){var n=this;e=l(e);var i=new pe(function(t,i){n.ready().then(function(){A(n._dbInfo,ge,function(r,o){if(r)return i(r);try{var a=o.objectStore(n._dbInfo.storeName),s=a["delete"](e);o.oncomplete=function(){t()},o.onerror=function(){i(s.error)},o.onabort=function(){var e=s.error?s.error:s.transaction.error;i(e)}}catch(c){i(c)}})})["catch"](i)});return c(i,t),i}function j(e){var t=this,n=new pe(function(e,n){t.ready().then(function(){A(t._dbInfo,ge,function(i,r){if(i)return n(i);try{var o=r.objectStore(t._dbInfo.storeName),a=o.clear();r.oncomplete=function(){e()},r.onabort=r.onerror=function(){var e=a.error?a.error:a.transaction.error;n(e)}}catch(s){n(s)}})})["catch"](n)});return c(n,e),n}function T(e){var t=this,n=new pe(function(e,n){t.ready().then(function(){A(t._dbInfo,be,function(i,r){if(i)return n(i);try{var o=r.objectStore(t._dbInfo.storeName),a=o.count();a.onsuccess=function(){e(a.result)},a.onerror=function(){n(a.error)}}catch(s){n(s)}})})["catch"](n)});return c(n,e),n}function N(e,t){var n=this,i=new pe(function(t,i){return e<0?void t(null):void n.ready().then(function(){A(n._dbInfo,be,function(r,o){if(r)return i(r);try{var a=o.objectStore(n._dbInfo.storeName),s=!1,c=a.openCursor();c.onsuccess=function(){var n=c.result;return n?void(0===e?t(n.key):s?t(n.key):(s=!0,n.advance(e))):void t(null)},c.onerror=function(){i(c.error)}}catch(u){i(u)}})})["catch"](i)});return c(i,t),i}function z(e){var t=this,n=new pe(function(e,n){t.ready().then(function(){A(t._dbInfo,be,function(i,r){if(i)return n(i);try{var o=r.objectStore(t._dbInfo.storeName),a=o.openCursor(),s=[];a.onsuccess=function(){var t=a.result;return t?(s.push(t.key),void t["continue"]()):void e(s)},a.onerror=function(){n(a.error)}}catch(c){n(c)}})})["catch"](n)});return c(n,e),n}function F(){return"function"==typeof openDatabase}function P(e){var t,n,i,r,o,a=.75*e.length,s=e.length,c=0;"="===e[e.length-1]&&(a--,"="===e[e.length-2]&&a--);var u=new ArrayBuffer(a),l=new Uint8Array(u);for(t=0;t<s;t+=4)n=we.indexOf(e[t]),i=we.indexOf(e[t+1]),r=we.indexOf(e[t+2]),o=we.indexOf(e[t+3]),l[c++]=n<<2|i>>4,l[c++]=(15&i)<<4|r>>2,l[c++]=(3&r)<<6|63&o;return u}function B(e){var t,n=new Uint8Array(e),i="";for(t=0;t<n.length;t+=3)i+=we[n[t]>>2],i+=we[(3&n[t])<<4|n[t+1]>>4],i+=we[(15&n[t+1])<<2|n[t+2]>>6],i+=we[63&n[t+2]];return n.length%3===2?i=i.substring(0,i.length-1)+"=":n.length%3===1&&(i=i.substring(0,i.length-2)+"=="),i}function q(e,t){var n="";if(e&&(n=Be.call(e)),e&&("[object ArrayBuffer]"===n||e.buffer&&"[object ArrayBuffer]"===Be.call(e.buffer))){var i,r=ke;e instanceof ArrayBuffer?(i=e,r+=Ae):(i=e.buffer,"[object Int8Array]"===n?r+=Ee:"[object Uint8Array]"===n?r+=De:"[object Uint8ClampedArray]"===n?r+=Re:"[object Int16Array]"===n?r+=Oe:"[object Uint16Array]"===n?r+=Te:"[object Int32Array]"===n?r+=je:"[object Uint32Array]"===n?r+=Ne:"[object Float32Array]"===n?r+=ze:"[object Float64Array]"===n?r+=Fe:t(new Error("Failed to get type for BinaryArray"))),t(r+B(i))}else if("[object Blob]"===n){var o=new FileReader;o.onload=function(){var n=Ie+e.type+"~"+B(this.result);t(ke+Ce+n)},o.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(a){console.error("Couldn't convert value into a JSON string: ",e),t(null,a)}}function M(e){if(e.substring(0,xe)!==ke)return JSON.parse(e);var t,n=e.substring(Pe),i=e.substring(xe,Pe);if(i===Ce&&Se.test(n)){var r=n.match(Se);t=r[1],n=n.substring(r[0].length)}var o=P(n);switch(i){case Ae:return o;case Ce:return s([o],{type:t});case Ee:return new Int8Array(o);case De:return new Uint8Array(o);case Re:return new Uint8ClampedArray(o);case Oe:return new Int16Array(o);case Te:return new Uint16Array(o);case je:return new Int32Array(o);case Ne:return new Uint32Array(o);case ze:return new Float32Array(o);case Fe:return new Float64Array(o);default:throw new Error("Unkown type: "+i)}}function H(e){var t=this,n={db:null};if(e)for(var i in e)n[i]="string"!=typeof e[i]?e[i].toString():e[i];var r=new pe(function(e,i){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(r){return i(r)}n.db.transaction(function(r){r.executeSql("CREATE TABLE IF NOT EXISTS "+n.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],function(){t._dbInfo=n,e()},function(e,t){i(t)})})});return n.serializer=qe,r}function L(e,t){var n=this;e=l(e);var i=new pe(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("SELECT * FROM "+r.storeName+" WHERE key = ? LIMIT 1",[e],function(e,n){var i=n.rows.length?n.rows.item(0).value:null;i&&(i=r.serializer.deserialize(i)),t(i)},function(e,t){i(t)})})})["catch"](i)});return c(i,t),i}function U(e,t){var n=this,i=new pe(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("SELECT * FROM "+r.storeName,[],function(n,i){for(var o=i.rows,a=o.length,s=0;s<a;s++){var c=o.item(s),u=c.value;if(u&&(u=r.serializer.deserialize(u)),u=e(u,c.key,s+1),void 0!==u)return void t(u)}t()},function(e,t){i(t)})})})["catch"](i)});return c(i,t),i}function V(e,t,n,i){var r=this;e=l(e);var o=new pe(function(o,a){r.ready().then(function(){void 0===t&&(t=null);var s=t,c=r._dbInfo;c.serializer.serialize(t,function(t,u){u?a(u):c.db.transaction(function(n){n.executeSql("INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[e,t],function(){o(s)},function(e,t){a(t)})},function(t){if(t.code===t.QUOTA_ERR){if(i>0)return void o(V.apply(r,[e,s,n,i-1]));a(t)}})})})["catch"](a)});return c(o,n),o}function W(e,t,n){return V.apply(this,[e,t,n,1])}function G(e,t){var n=this;e=l(e);var i=new pe(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("DELETE FROM "+r.storeName+" WHERE key = ?",[e],function(){t()},function(e,t){i(t)})})})["catch"](i)});return c(i,t),i}function K(e){var t=this,n=new pe(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){t.executeSql("DELETE FROM "+i.storeName,[],function(){e()},function(e,t){n(t)})})})["catch"](n)});return c(n,e),n}function J(e){var t=this,n=new pe(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){t.executeSql("SELECT COUNT(key) as c FROM "+i.storeName,[],function(t,n){var i=n.rows.item(0).c;e(i)},function(e,t){n(t)})})})["catch"](n)});return c(n,e),n}function Q(e,t){var n=this,i=new pe(function(t,i){n.ready().then(function(){var r=n._dbInfo;r.db.transaction(function(n){n.executeSql("SELECT key FROM "+r.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,n){var i=n.rows.length?n.rows.item(0).key:null;t(i)},function(e,t){i(t)})})})["catch"](i)});return c(i,t),i}function X(e){var t=this,n=new pe(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){t.executeSql("SELECT key FROM "+i.storeName,[],function(t,n){for(var i=[],r=0;r<n.rows.length;r++)i.push(n.rows.item(r).key);e(i)},function(e,t){n(t)})})})["catch"](n)});return c(n,e),n}function Y(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&"function"==typeof localStorage.setItem}catch(e){return!1}}function Z(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch(t){return!0}}function $(){return!Z()||localStorage.length>0}function ee(e){var t=this,n={};if(e)for(var i in e)n[i]=e[i];return n.keyPrefix=n.name+"/",n.storeName!==t._defaultConfig.storeName&&(n.keyPrefix+=n.storeName+"/"),$()?(t._dbInfo=n,n.serializer=qe,pe.resolve()):pe.reject()}function te(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,n=localStorage.length-1;n>=0;n--){var i=localStorage.key(n);0===i.indexOf(e)&&localStorage.removeItem(i)}});return c(n,e),n}function ne(e,t){var n=this;e=l(e);var i=n.ready().then(function(){var t=n._dbInfo,i=localStorage.getItem(t.keyPrefix+e);return i&&(i=t.serializer.deserialize(i)),i});return c(i,t),i}function ie(e,t){var n=this,i=n.ready().then(function(){for(var t=n._dbInfo,i=t.keyPrefix,r=i.length,o=localStorage.length,a=1,s=0;s<o;s++){var c=localStorage.key(s);if(0===c.indexOf(i)){var u=localStorage.getItem(c);if(u&&(u=t.serializer.deserialize(u)),u=e(u,c.substring(r),a++),void 0!==u)return u}}});return c(i,t),i}function re(e,t){var n=this,i=n.ready().then(function(){var t,i=n._dbInfo;try{t=localStorage.key(e)}catch(r){t=null}return t&&(t=t.substring(i.keyPrefix.length)),t});return c(i,t),i}function oe(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo,n=localStorage.length,i=[],r=0;r<n;r++){var o=localStorage.key(r);0===o.indexOf(e.keyPrefix)&&i.push(o.substring(e.keyPrefix.length))}return i});return c(n,e),n}function ae(e){var t=this,n=t.keys().then(function(e){return e.length});return c(n,e),n}function se(e,t){var n=this;e=l(e);var i=n.ready().then(function(){var t=n._dbInfo;localStorage.removeItem(t.keyPrefix+e)});return c(i,t),i}function ce(e,t,n){var i=this;e=l(e);var r=i.ready().then(function(){void 0===t&&(t=null);var n=t;return new pe(function(r,o){var a=i._dbInfo;a.serializer.serialize(t,function(t,i){if(i)o(i);else try{localStorage.setItem(a.keyPrefix+e,t),r(n)}catch(s){"QuotaExceededError"!==s.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==s.name||o(s),o(s)}})})});return c(r,n),r}function ue(e,t){e[t]=function(){var n=arguments;return e.ready().then(function(){return e[t].apply(e,n)})}}function le(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var n in t)t.hasOwnProperty(n)&&(Le(t[n])?arguments[0][n]=t[n].slice():arguments[0][n]=t[n])}return arguments[0]}var de="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},fe=o();"undefined"==typeof r&&e("lie/polyfill");var he,_e,pe=r,ve="local-forage-detect-blob-support",ye=Object.prototype.toString,be="readonly",ge="readwrite",me={_driver:"asyncStorage",_initStorage:C,_support:a(),iterate:D,getItem:E,setItem:R,removeItem:O,clear:j,length:T,key:N,keys:z},we="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ie="~~local_forage_type~",Se=/^~~local_forage_type~([^~]+)~/,ke="__lfsc__:",xe=ke.length,Ae="arbf",Ce="blob",Ee="si08",De="ui08",Re="uic8",Oe="si16",je="si32",Te="ur16",Ne="ui32",ze="fl32",Fe="fl64",Pe=xe+Ae.length,Be=Object.prototype.toString,qe={serialize:q,deserialize:M,stringToBuffer:P,bufferToString:B},Me={_driver:"webSQLStorage",_initStorage:H,_support:F(),iterate:U,getItem:L,setItem:W,removeItem:G,clear:K,length:J,key:Q,keys:X},He={_driver:"localStorageWrapper",_initStorage:ee,_support:Y(),iterate:ie,getItem:ne,setItem:ce,removeItem:se,clear:te,length:ae,key:re,keys:oe},Le=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},Ue={},Ve={},We={INDEXEDDB:me,WEBSQL:Me,LOCALSTORAGE:He},Ge=[We.INDEXEDDB._driver,We.WEBSQL._driver,We.LOCALSTORAGE._driver],Ke=["clear","getItem","iterate","key","keys","length","removeItem","setItem"],Je={description:"",driver:Ge.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1},Qe=function(){function e(t){i(this,e);for(var n in We)if(We.hasOwnProperty(n)){var r=We[n],o=r._driver;this[n]=o,Ue[o]||this.defineDriver(r)}this._defaultConfig=le({},Je),this._config=le({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver)["catch"](function(){})}return e.prototype.config=function(e){if("object"===("undefined"==typeof e?"undefined":de(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e&&e.driver)||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,n){var i=new pe(function(t,n){try{var i=e._driver,r=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void n(r);for(var o=Ke.concat("_initStorage"),a=0,s=o.length;a<s;a++){var c=o[a];if(!c||!e[c]||"function"!=typeof e[c])return void n(r)}var u=function(n){Ue[i]&&console.info("Redefining LocalForage driver: "+i),Ue[i]=e,Ve[i]=n,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(u,n):u(!!e._support):u(!0)}catch(l){n(l)}});return u(i,t,n),i},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,n){var i=Ue[e]?pe.resolve(Ue[e]):pe.reject(new Error("Driver not found."));return u(i,t,n),i},e.prototype.getSerializer=function(e){var t=pe.resolve(qe);return u(t,e),t},e.prototype.ready=function(e){var t=this,n=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready});return u(n,e,e),n},e.prototype.setDriver=function(e,t,n){function i(){a._config.driver=a.driver()}function r(e){return a._extend(e),i(),a._ready=a._initStorage(a._config),a._ready}function o(e){return function(){function t(){for(;n<e.length;){var o=e[n];return n++,a._dbInfo=null,a._ready=null,a.getDriver(o).then(r)["catch"](t)}i();var s=new Error("No available storage method found.");return a._driverSet=pe.reject(s),a._driverSet}var n=0;return t()}}var a=this;Le(e)||(e=[e]);var s=this._getSupportedDrivers(e),c=null!==this._driverSet?this._driverSet["catch"](function(){return pe.resolve()}):pe.resolve();return this._driverSet=c.then(function(){var e=s[0];return a._dbInfo=null,a._ready=null,a.getDriver(e).then(function(e){a._driver=e._driver,i(),a._wrapLibraryMethodsWithReady(),a._initDriver=o(s)})})["catch"](function(){i();var e=new Error("No available storage method found.");return a._driverSet=pe.reject(e),a._driverSet}),u(this._driverSet,t,n),this._driverSet},e.prototype.supports=function(e){return!!Ve[e]},e.prototype._extend=function(e){le(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var r=e[n];this.supports(r)&&t.push(r)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=Ke.length;e<t;e++)ue(this,Ke[e])},e.prototype.createInstance=function(t){return new e(t)},e}(),Xe=new Qe;t.exports=Xe},{undefined:void 0}]},{},[1])(1)});var o=n.exports;t.modules.define("localForage",[],function(e){e(o)})}(t);var n=function(){this._initialized=!1,this._key=null,this._token=null};if(n.prototype.initialize=function(e){var n=t.vow.defer();return t.modules.require(["cloud.dataSyncApi.config","component.util","cloud.Error","vow","global"],function(t,i,r,o,a){if(e)if(e.key||e.token||e.with_credentials)if(e.token)this._token=e.token,this._initialized=!0,n.resolve();else if(e.with_credentials)this._withCredentials=!0,this._initialized=!0,n.resolve();else{var s=a.open(t.oauthLoginPage.replace(/{{\s*key\s*}}/g,e.key),"oauth",t.oauthWindowParameters);if(s)var c=a.setInterval(function(){if(s.closed)a.clearInterval(c),n.reject(new r({code:401}));else try{var e=s.location.hash.match(/access_token=([0-9a-f]+)/);e&&(this._token=e[1],this._initialized=!0,s.close(),a.clearInterval(c),n.resolve(this._token))}catch(t){}}.bind(this),100);else n.reject(new r({code:401}))}else n.reject(new r({message:"Either `options.key` or `options.token` Parameter Required"}));else n.reject(new r({message:"`options` Parameter Required"}))}.bind(this)),n.promise()},n.prototype.isInitialized=function(){return this._initialized},n.prototype.isInitiaized=n.prototype.isInitialized,n.prototype.getToken=function(){return this._token},n.prototype.withCredentials=function(){return this._withCredentials},t.cloud.client=new n,t.modules.define("cloud.client",[],function(e){e(t.cloud.client)}),t.modules.define("cloud.Error",["component.util"],function(e,t){var n={400:"Bad Request",401:"Not Authorized",403:"Forbidden",404:"Not Found",409:"Conflict",410:"Gone",421:"Locked",423:"Too Many Requests",500:"Internal Server Error"},i=function(e){t.extend(this,{code:400},e),this.message||(this.message=n[this.code]),Error.captureStackTrace?Error.captureStackTrace(this,i):this.stack=(new Error).stack};t.defineClass(i,Error,{toString:function(){return this.code+" "+this.message}}),e(i)}),t.cloud.dataSyncApi={openDatabase:function(e){return this._require(["cloud.dataSyncApi.Database"]).spread(function(t){return new t(e)})},getDatabaseCount:function(e){return this._require(["component.util","cloud.dataSyncApi.http"]).spread(function(t,n){return n.getDatabases(t.extend({limit:0,offset:0},e)).then(function(e){return e.data.total})})},getDatabaseMetadata:function(e){if(!e||!e.database_id)return this._fail("`options.database_id` Parameter Required");var t=this._castMetadata.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.getDatabases(e).then(function(e){return t(e.data)})})},listDatabaseMetadata:function(e){if(!e||"undefined"==typeof e.offset||"undefined"==typeof e.limit)return this._fail("`options.offset` and `options.limit` Parameters Required");var t=this._castMetadata.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.getDatabases(e).then(function(e){return e.data.items.map(t)})})},createDatabase:function(e){var t=this._fail.bind(this);return this._require(["cloud.dataSyncApi.http"]).spread(function(n){return n.putDatabase(e).then(function(n){return e&&!e.ignore_existing&&200==n.code?t(409,'Database "'+e.database_id+'" Already Exists'):Number(n.headers.etag)},this)})},deleteDatabase:function(e){return this._require(["cloud.dataSyncApi.http"]).spread(function(t){return t.deleteDatabase(e).then(function(){return null})})},closeAllDatabases:function(){return this._require(["cloud.dataSyncApi.Database"]).then(function(e){return e.closeAll(),null})},_require:function(e){var n=t.vow.defer();return t.modules.require(e,function(){n.resolve([].slice.call(arguments))}),n.promise()},_castMetadata:function(e){return{database_id:e.database_id,revision:e.revision,title:e.title,created:new Date(e.created),modified:new Date(e.modified),records_count:e.records_count,size:e.size}},_fail:function(e,n){n||(n=e,e=400);var i=t.vow.defer();return t.modules.require(["cloud.Error"],function(t){i.reject(new t({code:e,message:n}))}),i.promise()}},t.modules.define("cloud.dataSyncApi",[],function(e){e(t.cloud.dataSyncApi)}),t.modules.define("component.util",function(e){var t={augment:function(e,n,i){return e.prototype=(Object.create||function(e){function t(){}return t.prototype=e,new t})(n.prototype),e.prototype.constructor=e,e.superclass=n.prototype,e.superclass.constructor=n,i&&t.extend(e.prototype,i),e.prototype},extend:function(e){for(var t=1,n=arguments.length;t<n;t++){var i=arguments[t];if(i)for(var r=Object.keys(i),o=0,a=r.length;o<a;o++)e[r[o]]=i[r[o]]}return e},defineClass:function(e){var n=1,i="function"==typeof arguments[n]?arguments[n++]:null;i&&t.augment(e,i);for(var r=arguments.length;n<r;)t.extend(e.prototype,arguments[n++]);return e},cancelableCallback:function(e){var t=!1,n=function(){t||e.apply(null,[].slice.call(arguments))};return n.cancel=function(){t=!0},n}};e(t)}),t.modules.define("component.xhr",["global","vow","cloud.Error"],function(e,t,n,i){var r=t.XMLHttpRequest,o=function(e){return e.split("\r\n").reduce(function(e,t){var n=t.split(": ");return 2==n.length&&(e[n[0].toLowerCase()]=n[1].trim()),e},{})};e(function(e,a){a=a||{},a.queryParams&&(e+=(e.indexOf("?")==-1?"?":"&")+Object.keys(a.queryParams).map(function(e){return e+"="+t.encodeURIComponent(a.queryParams[e])}).join("&"));var s=n.defer(),c=new r,u=a.headers||{},l=a.method||"GET";return"GET"==l||u["Content-Type"]||(u["Content-Type"]="application/json"),u["X-Requested-With"]||(u["X-Requested-With"]="XMLHttpRequest"),c.onload=function(){var e={code:this.status,data:this.responseText,headers:"undefined"==typeof a.parseResponseHeaders||a.parseResponseHeaders?o(this.getAllResponseHeaders()):this.getAllResponseHeaders()};if(a.parse)try{e.data=JSON.parse(e.data)}catch(t){s.reject(new i({message:"JSON Parse Error "+e.data}))}s.resolve(e)},c.onerror=function(){s.reject(new i({code:500}))},c.open(l,e,!0),Object.keys(u).forEach(function(e){c.setRequestHeader(e,u[e])}),a.withCredentials&&(c.withCredentials=!0),"undefined"!=typeof a.data?c.send("string"==typeof a.data?a.data:JSON.stringify(a.data)):c.send(),s.promise().timeout(a.timeout||3e4).fail(function(e){throw e instanceof n.TimedOutError?new i({code:500,message:"Timeout Exceeded"}):e})})}),t.modules.define("cloud.dataSyncApi.Conflict",["component.util"],function(e,t){var n=function(e){this._type=e.type,this._fieldChangeConflicts=e.field_change_conflicts};t.defineClass(n,{getType:function(){return this._type},getFieldChangeConflicts:function(){return this._fieldChangeConflicts}}),e(n)}),t.modules.define("cloud.dataSyncApi.Database",["cloud.dataSyncApi.config","cloud.dataSyncApi.http","cloud.client","cloud.dataSyncApi.DatasetController","cloud.dataSyncApi.watcher","cloud.dataSyncApi.Transaction","cloud.dataSyncApi.Operation","cloud.dataSyncApi.politics","cloud.Error","component.util","vow"],function(e,t,n,i,r,o,a,s,c,u,l,d){function f(e,t,n){var i=t.operations,r=e.dryRun(t.base_revision,i),o=r.conflicts;return o.length&&n&&(i=c[n](i,o),r=e.dryRun(t.base_revision,i),o=r.conflicts),{operations:i,conflicts:o,revisionHistory:r.revisionHistory}}var h=[],_=function(e){return this._id=e.database_id,this._context=e.context,this._token=e.token,this._locked=!0,this._datasetController=null,this._pendingCallbacks=[],this._possiblyMissedDelta=null,this._missedDelta=null,this._datasetController=null,this._collectionId=e.collection_id,this._listeners={update:[]},h.push(this),r.create(e).then(function(t){return this._datasetController=t,this._locked=!1,(e.background_sync||"undefined"==typeof e.background_sync)&&(this._watchCallback=this.update.bind(this),o.subscribe(this,this._watchCallback)),this},null,this)};_.closeAll=function(){h.slice().forEach(function(e){e.close()})},l.defineClass(_,{on:function(e,t){if("undefined"==typeof this._listeners[e])throw new u({message:"Event `"+e+"` is not supported"});if("function"!=typeof t)throw new u({message:"`callback` parameter must be a function"});return this._listeners[e].push(t),this},off:function(e,t){if("undefined"==typeof this._listeners[e])throw new u({message:"Event `"+e+"` is not supported"});var n=this._listeners[e].indexOf(t);if(n==-1)throw new u({code:404,message:"Callback not found"});return this._listeners[e].splice(n,1),this},_notify:function(e,t){var n=(this._listeners[e]||[]).slice();n.forEach(function(e){e(t)})},update:function(){return this._executeExclusiveTask(this._explicitUpdate.bind(this))},close:function(){this._watchCallback&&(o.unsubscribe(this,this._watchCallback),this._watchCallback=null),this._datasetController&&(this._datasetController.close(),this._datasetController=null),this._locked=!0;var e=h.indexOf(this);e!=-1&&h.splice(e,1)},_explicitUpdate:function(){var e=this.getRevision();return this._datasetController.update({possiblyMissedDelta:this._possiblyMissedDelta}).then(function(t){return t.missedDeltaFound&&(this._missedDelta=this._possiblyMissedDelta,this._possiblyMissedDelta=null),t.revision!=e&&this._notify("update",t.revision),t.revision},null,this)},_executeExclusiveTask:function(e){var t=this._datasetController.isGone();if(t)return t;var n=d.defer();return this._pendingCallbacks.push([e,n]),this._locked||this._proceedPendingQueue(),n.promise()},_proceedPendingQueue:function(){var e=this._pendingCallbacks.shift(),t=e[0],n=e[1];this._locked=!0,t().then(function(e){n.resolve(e),this._locked=!1,this._pendingCallbacks.length&&this._proceedPendingQueue()},function(e){n.reject(e),this._locked=!1,this._pendingCallbacks.length&&this._proceedPendingQueue()},this)},getRevision:function(){return this._datasetController.getDataset().getRevision()},getDatabaseId:function(){return this._id},getContext:function(){return this._context},createTransaction:function(){return new a(this,function(e,t){return this._executeExclusiveTask(this._patch.bind(this,e,t))}.bind(this),this._collectionId)},_patch:function(e,t){var n=d.defer(),i=this._datasetController.getDataset(),r=e.delta_id,o=function(){n.resolve(i.getRevision())},a=function(e){e.postDeltaFail&&(this._possiblyMissedDelta=e.postDeltaFail),n.reject(e)}.bind(this);if(this._missedDelta&&r==this._missedDelta)this._missedDelta=null,o();else{var c=f(i,e,t),l=c.operations,h=c.conflicts,_=c.revisionHistory,p={base_revision:this.getRevision(),delta_id:e.delta_id,changes:l.map(s.json.serialize)};h.length?a(new u({code:409,conflicts:h,revisionHistory:_})):l.length?this._postDeltas({database_id:this._id,delta_id:r,base_revision:this.getRevision(),context:this._context,token:this._token,data:p}).then(function(e){p.revision=e,i.applyDeltas([p]),o(),this._notify("update",e)},function(n){409==n.code?this._explicitUpdate().then(function(){this._patch(e,t).then(o,a);
},a,this):a(n)},this):o()}return n.promise()},_postDeltas:function(e){var t=d.defer(),i=function(e){t.reject(e)};return n.postDeltas(e).then(function(n){200==n.code||201==n.code?t.resolve(Number(n.headers.etag)):(n.code>=500&&(n.postDeltaFail=e.delta_id),i(new u(n)))},function(t){t.postDeltaFail=e.delta_id,i(t)},this),t.promise()},getRecord:function(e,t){return this._datasetController.getDataset().getRecord(e,t)},getRecordsCount:function(){return this._datasetController.getDataset().getLength()},iterator:function(e){return this._datasetController.getDataset().iterator(e)},forEach:function(e,t,n){"string"!=typeof e&&(n=t,t=e,e=null);for(var i=this._datasetController.getDataset().iterator(e),r=i.next(),o=0;!r.done;)t.call(n||null,r.value,o++),r=i.next();return this},filter:function(e,t,n){this.forEach(function(i,r){e(i,r)&&t.call(n||null,i,r)})}}),e(_)}),t.modules.define("cloud.dataSyncApi.Dataset",["cloud.dataSyncApi.Record","cloud.dataSyncApi.Operation","cloud.dataSyncApi.FieldOperation","cloud.dataSyncApi.Conflict","cloud.Error","component.util"],function(e,t,n,i,r,o,a){function s(e){return Object.keys(e).reduce(function(t,n){return t[n]=Object.keys(e[n]).reduce(function(e,t){return e[t]=!0,e},{}),t},{})}function c(e){return e.map(function(e){return n.json.deserialize(e)})}var u=function(e,n,i){var r=this._index={},s=this._collectionId=i&&i.collection_id,c=i&&i.collection_policy||"restrict";this._revision=Number(e),this._revisionHistory=[],this._records=n.map(function(e){return e instanceof t||(s&&!e.collection_id&&(e=a.extend({collection_id:s},e)),e=new t(e)),e}),s&&(this._records=this._records.filter(function(e){if(e.getCollectionId()!=s){if("restrict"==c)throw new o({message:"`collection_id` Must Match Current Filter"});return!1}return!0})),this._records.forEach(function(e){var t=e.getCollectionId(),n=e.getRecordId();if(r[t]||(r[t]={}),r[t][n])throw new o({message:"Record with `collection_id` and `record_id` Provided Already Exists",collection_id:t,record_id:n});return r[t][n]=e,e})};u.json={deserialize:function(e,n){return new u(e.revision,e.records.items.map(function(e){return t.json.deserialize(e)}),n)},serialize:function(e){for(var n=[],i=e.iterator(),r=i.next();!r.done;)n.push(t.json.serialize(r.value)),r=i.next();return{revision:e.getRevision(),records:{items:n}}}},a.defineClass(u,{getRecord:function(e,t){if(this._collectionId)if(t){if(e!=this._collectionId)throw new o({message:"`collection_id` Parameter Must Match Collection Filter"})}else t=e,e=this._collectionId;if(!e)throw new o({message:"`collection_id` Parameter Required"});if(!t)throw new o({message:"`record_id` Parameter Required"});return this._index[e]&&this._index[e][t]},getRevision:function(){return this._revision},getLength:function(){return this._records.length},getCollectionId:function(){return this._collectionId},iterator:function(e){var t=-1,n=this._records;return{next:function(){if(e){do t++;while(t<n.length&&n[t].getCollectionId()!=e)}else t++;return t<n.length?{value:n[t]}:{done:!0}}}},applyDeltas:function(e){var n=this._index,r=this._revisionHistory,a=this._revision,s=this._collectionId;e.forEach(function(e){var c={};if(e.base_revision!=a)throw new o({message:"Incorrect delta base_revision"});e.changes.forEach(function(e){var r=e.collection_id,o=e.record_id;if(!s||r==s)switch(c[r]||(c[r]={}),c[r][o]=!0,e.change_type){case"insert":case"set":n[r]||(n[r]={}),n[r][o]=t.json.deserialize(e,!0);break;case"delete":delete n[r][o];break;case"update":var a=n[r][o];e.changes.forEach(function(e){a.applyFieldOperation(i.json.deserialize(e))})}}),r.push({base_revision:e.base_revision,delta_id:e.delta_id,revision:e.revision,alteredRecords:c,changes:e.changes}),a=e.revision});var c=this._records=[];Object.keys(n).forEach(function(e){Object.keys(n[e]).forEach(function(t){c.push(n[e][t])})}),this._revision=a},ifModifiedSince:function(e){var t=e.collection_id||this._collectionId,n=e.record_id,i=e.revision,r=this._locateRevision(i);if(r!=-1)for(var o=r;o<this._revisionHistory.length;o++){var a=this._revisionHistory[o];if(a.alteredRecords[t]&&a.alteredRecords[t][n])return!0}return!1},_locateRevision:function(e){for(var t=0;t<this._revisionHistory.length;t++)if(this._revisionHistory[t].base_revision==e)return t;return-1},dryRun:function(e,i){var o=[],a=s(this._index),c=this._index,u=this._collectionId;return i.forEach(function(i,s){var l=i.getCollectionId(),d=i.getRecordId();if(!u||l==u)if(this.ifModifiedSince({collection_id:l,record_id:d,revision:e}))o.push({index:s,conflict:new r({type:"both_modified",operation:i})});else switch(i.getType()){case"insert":a[l]&&a[l][d]?o.push({index:s,conflict:new r({type:"record_already_exists",operation:i})}):(a[l]||(a[l]={}),a[l][d]=t.json.deserialize(n.json.serialize(i),!0));break;case"set":a[l]||(a[l]={}),a[l][d]=t.json.deserialize(n.json.serialize(i),!0);break;case"delete":a[l]&&a[l][d]?delete a[l][d]:o.push({index:s,conflict:new r({type:"delete_non_existent_record",operation:i})});break;case"update":if(a[l]&&a[l][d]){var f=a[l][d],h=[];f===!0&&(f=c[l][d].copy()),i.getFieldOperations().forEach(function(e,t){var n=f.dryRun(e);n?h.push({type:n,index:t}):f.applyFieldOperation(e)}),h.length?o.push({index:s,conflict:new r({type:"invalid_field_change",operation:i,field_change_conflicts:h})}):a[l][d]=f}else o.push({index:s,conflict:new r({type:"update_non_existent_record",operation:i})})}},this),{conflicts:o,revisionHistory:o.length?this._getRevisionHistory(e):[]}},_getRevisionHistory:function(e){var t=this._locateRevision(e);if(t!=-1){for(var n=[],i=t;i<this._revisionHistory.length;i++){var r=this._revisionHistory[i];n.push({base_revision:r.base_revision,revision:r.revision,delta_id:r.delta_id,operations:c(r.changes)})}return n}return[]}}),e(u)}),t.modules.define("cloud.dataSyncApi.DatasetController",["cloud.dataSyncApi.config","cloud.dataSyncApi.http","cloud.dataSyncApi.Dataset","cloud.dataSyncApi.cache","cloud.Error","component.util","vow"],function(e,t,n,i,r,o,a,s){function c(e,i){var r=[],c=s.defer(),u=function(e){c.reject(e)},l=function(i){return n.getDeltas(a.extend({},e,{base_revision:i,limit:t.deltaLimit})).then(function(e){if(200==e.code)return e.data;throw new o({code:e.code})})},d=function(e){var t=e.revision;r.push(e.items);var n=e.items.length?e.items[e.items.length-1].revision:t;n==t?f():l(n).then(d,u)},f=function(){r=[].concat.apply([],r),c.resolve(r)};return l(i).then(d,u),c.promise()}var u=function(e){return this._options=e||{},this._gone=!1,this._updatePromise=null,this._dataset=null,this._createDataset().then(function(){return this},null,this)};u.create=function(e){return new u(e)},a.defineClass(u,{getDataset:function(){return this._dataset},isGone:function(){return this._gone},close:function(){this._onGone()},_createDataset:function(){return n.putDatabase(this._options).then(function(e){if(200!=e.code&&201!=e.code)throw new o({code:e.code});return this._getSnapshot(e.data)},null,this)},_getSnapshot:function(e){var t=this._options,n=this._databaseHandle=e.handle;return n&&t.use_client_storage?r.getDataset(t.context,n,t.collection_id).then(function(e){return this._initDataset(e,{need_update:!0})},function(){return this._getHttpSnapshot()},this):this._getHttpSnapshot()},_getHttpSnapshot:function(){var e=this._options;return n.getSnapshot(this._options).then(function(t){if(200==t.code)return this._initDataset(i.json.deserialize(t.data,{collection_id:e.collection_id}));throw new o({code:t.code})},null,this)},_initDataset:function(e,t){var n=this._options;return this._dataset=e,t&&t.need_update?this.update().fail(function(e){if(410==e.code)return this._getHttpSnapshot(n);throw e},this):this._saveSnapshot().always(function(){return s.resolve()})},_saveSnapshot:function(){return this._options.use_client_storage&&this._databaseHandle?r.saveDataset(this._options.context,this._databaseHandle,this._dataset):s.resolve()},update:function(e){return this._gone?this._gone:(this._updatePromise||(this._updatePromise=this._applyDeltas(e).then(function(e){return this._saveSnapshot().always(function(){return this._updatePromise=null,e},this)},function(e){throw 410==e.code&&this._onGone(),this._updatePromise=null,e},this)),this._updatePromise)},_applyDeltas:function(e){var t=this._dataset;return c(this._options,t.getRevision()).then(function(n){n.length&&t.applyDeltas(n);var i=!1;return e&&e.possiblyMissedDelta&&n.forEach(function(t){t.delta_id==e.possiblyMissedDelta&&(i=!0)}),{revision:t.getRevision(),missedDeltaFound:i}})},_onGone:function(){this._gone=s.reject({code:410,message:"Database snapshot outdated"})}}),e(u)}),t.modules.define("cloud.dataSyncApi.FieldOperation",["component.util","cloud.dataSyncApi.Value"],function(e,t,n){var i=function(e){this._type=e.type,this._fieldId=e.field_id,["set","list_item_set","list_item_insert"].indexOf(this._type)!=-1?this._value=e.value instanceof n?e.value:new n(e.value):this._value=null,["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(this._type)!=-1?this._index=Math.floor(e.index):this._index=null,"list_item_move"==this._type?this._newIndex=Math.floor(e.new_index):this._newIndex=null};i.json={serialize:function(e){var t=e.getType(),i={field_id:e.getFieldId(),change_type:t};return"set"!=t&&"list_item_set"!=t&&"list_item_insert"!=t||(i.value=n.json.serialize(e.getValue())),"list_item_move"==t&&(i.list_item_dest=e.getNewIndex()),0==t.indexOf("list_item_")&&(i.list_item=e.getIndex()),i},deserialize:function(e){var t=e.change_type,r={type:t,field_id:e.field_id};return"set"!=t&&"list_item_set"!=t&&"list_item_insert"!=t||(r.value=n.json.deserialize(e.value)),"list_item_move"==t&&(r.new_index=e.list_item_dest),0==t.indexOf("list_item_")&&(r.index=e.list_item),new i(r)}},t.defineClass(i,{getType:function(){return this._type},getFieldId:function(){return this._fieldId},getValue:function(){return this._value},getIndex:function(){return this._index},getNewIndex:function(){return this._newIndex}}),e(i)}),t.modules.define("cloud.dataSyncApi.Operation",["cloud.dataSyncApi.FieldOperation","cloud.dataSyncApi.Record","component.util"],function(e,t,n,i){var r=function(e){this._type=e.type,this._collectionId=e.collection_id,this._recordId=e.record_id,["insert","update","set"].indexOf(this._type)!=-1?this._fieldOperations=(e.field_operations||[]).map(function(e){return e instanceof t?e:new t(e)}):this._fieldOperations=null};r.json={serialize:function(e){var n=e.getType(),i={record_id:e.getRecordId(),collection_id:e.getCollectionId(),change_type:n};return["insert","update","set"].indexOf(n)!=-1&&(i.changes=e.getFieldOperations().map(function(e){return t.json.serialize(e)})),i},deserialize:function(e){var n=e.change_type,i={type:n,record_id:e.record_id,collection_id:e.collection_id};return["insert","update","set"].indexOf(this._type)!=-1&&(i.field_changes=e.changes.map(function(e){return t.json.deserialize(e)})),new r(i)}},i.defineClass(r,{getType:function(){return this._type},getRecordId:function(){return this._recordId},getCollectionId:function(){return this._collectionId},getFieldOperations:function(){return this._fieldOperations?this._fieldOperations.slice():null}}),e(r)}),t.modules.define("cloud.dataSyncApi.Record",["cloud.Error","component.util","cloud.dataSyncApi.Value"],function(e,t,n,i){var r=function(e){this._collectionId=e.collection_id,this._recordId=e.record_id,this._fields=Object.keys(e.fields||{}).reduce(function(t,n){return t[n]=e.fields[n]instanceof i?e.fields[n]:new i(e.fields[n]),t},{})};r.json={deserialize:function(e,n){return new r(n||!e.fields?{collection_id:e.collection_id,record_id:e.record_id,fields:(e.changes||[]).reduce(function(e,n){if("set"!=n.change_type)throw new t({message:"Field change type is not supported",type:n.change_type});return e[n.field_id]=i.json.deserialize(n.value),e},{})}:{collection_id:e.collection_id,record_id:e.record_id,fields:e.fields.reduce(function(e,t){return e[t.field_id]=i.json.deserialize(t.value),e},{})})},serialize:function(e){return{record_id:e.getRecordId(),collection_id:e.getCollectionId(),change_type:"set",changes:e.getFieldIds().map(function(t){return{field_id:t,change_type:"set",value:i.json.serialize(e.getFieldValue(t))}})}}},n.defineClass(r,{getCollectionId:function(){return this._collectionId},getRecordId:function(){return this._recordId},getFieldIds:function(){return Object.keys(this._fields)},getFieldValue:function(e){return this._fields[e]},getFields:function(){return n.extend({},this._fields)},applyFieldOperation:function(e){var n=this.dryRun(e);if(n)throw new t({code:409,type:n});var i=e.getFieldId(),r=e.getType(),o=this._fields,a=o[i];return"set"==r?this._fields[i]=e.getValue():"delete"==r?delete this._fields[i]:["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(r)!=-1&&a.applyListOperation(e),this},copy:function(){var e=this._fields;return new r({collection_id:this.getCollectionId(),record_id:this.getRecordId(),fields:Object.keys(this._fields).reduce(function(t,n){return t[n]=e[n].copy(),t},{})})},dryRun:function(e){var t=e.getFieldId(),n=e.getType(),i=this._fields,r=i[t];return"set"==n?null:"delete"!=n?["list_item_set","list_item_delete","list_item_insert","list_item_move"].indexOf(n)!=-1?"undefined"==typeof r?"modify_non_existent_field":"list"!=r.getType()?"modify_not_a_list_field":r.dryRun(e):"unknown_type":"undefined"==typeof r?"delete_non_existent_field":null}}),e(r)}),t.modules.define("cloud.dataSyncApi.Transaction",["cloud.dataSyncApi.Record","cloud.dataSyncApi.Operation","cloud.dataSyncApi.FieldOperation","component.util"],function(e,t,n,i,r){function o(e,n,i){var r={type:e};if(n instanceof t?(r.collection_id=n.getCollectionId(),r.record_id=n.getRecordId()):(r.collection_id=n.collection_id||i,r.record_id=n.record_id),i&&r.collection_id!=i)throw new Error("`collection_id` Parameter Must Match Current Filter");return r}var a=function(e,t,n){this._database=e,this._patchCallback=t,this._deltaId="ya_cloud_data_js_api_1_"+Math.random().toString(),this._baseRevision=e.getRevision(),this._operations=[],this._collectionId=n};r.defineClass(a,{addOperations:function(e){var t=this._collectionId;return this._operations=this._operations.concat([].concat(e).map(function(e){if(e instanceof n||(t&&!e.collectionId&&(e=r.extend({collection_id:t},e)),e=new n(e)),t&&e.getCollectionId()!=t)throw new Error("`collection_id` Parameter Value Must Match Current Filter");return e})),this},push:function(e){return this._patchCallback({delta_id:this._deltaId,base_revision:this._baseRevision,operations:this._operations},e)},getDatabase:function(){return this._database},getBaseRevision:function(){return this._baseRevision},getOperations:function(){return this._operations.slice()},insertRecords:function(e){var r=this._collectionId;return this.addOperations([].concat(e).map(function(e){var a=o("insert",e,r);return e instanceof t?a.field_operations=e.getFieldIds().map(function(t){return new i({type:"set",field_id:t,value:e.getFieldValue(t)})}):a.field_operations=e.fields?Object.keys(e.fields).map(function(t){return new i({type:"set",field_id:t,value:e.fields[t]})}):[],new n(a)}))},deleteRecords:function(e){var t=this._collectionId;return this.addOperations([].concat(e).map(function(e){return new n(o("delete",e,t))}))},setRecordFields:function(e,t){var r=o("set",e,this._collectionId);return Array.isArray(t)?r.field_operations=t:r.field_operations=Object.keys(t||{}).map(function(e){return new i({type:"set",field_id:e,value:t[e]})}),this.addOperations(new n(r))},updateRecordFields:function(e,t){var r=o("update",e,this._collectionId);return Array.isArray(t)?r.field_operations=t:r.field_operations=Object.keys(t).map(function(e){return new i("undefined"==typeof t[e]?{type:"delete",field_id:e}:{type:"set",field_id:e,value:t[e]})}),this.addOperations(new n(r))},insertRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_insert",field_id:t.field_id,index:t.index,value:t.value})],this.addOperations(new n(r))},setRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_set",field_id:t.field_id,index:t.index,value:t.value})],this.addOperations(new n(r))},moveRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_move",field_id:t.field_id,index:t.index,new_index:t.new_index})],this.addOperations(new n(r))},deleteRecordFieldListItem:function(e,t){var r=o("update",e,this._collectionId);return r.field_operations=[new i({type:"list_item_delete",field_id:t.field_id,index:t.index})],this.addOperations(new n(r))}}),e(a)}),t.modules.define("cloud.dataSyncApi.Value",["component.util","cloud.Error","global"],function(e,t,n,i){function r(e){switch(typeof e){case"number":return e==Number.POSITIVE_INFINITY?"inf":e==Number.NEGATIVE_INFINITY?"ninf":i.isNaN(e)?"nan":"double";case"string":return"string";case"boolean":return"boolean";case"object":return null==e?"null":"undefined"!=typeof i.ArrayBuffer&&(e instanceof i.ArrayBuffer||e.buffer&&e.buffer instanceof i.ArrayBuffer)?"binary":e instanceof Date?"datetime":e instanceof Boolean?"boolean":e instanceof Number?"double":i.Array.isArray(e)?"list":"string";default:throw new n({message:"Type unknown"})}}function o(e,t){switch(e){case"string":return t.toString();case"integer":return Math.floor(Number(t));case"double":return Number(t);case"boolean":return t instanceof Boolean?t.valueOf():Boolean(t);case"datetime":return t instanceof Date?t.toISOString():t;case"binary":return"undefined"!=typeof i.ArrayBuffer?t instanceof i.ArrayBuffer?i.btoa(String.fromCharCode.apply(null,new i.Uint8Array(t))):t.buffer&&t.buffer instanceof i.ArrayBuffer?i.btoa(String.fromCharCode.apply(null,new i.Uint8Array(t.buffer))):t.toString():t.toString();case"null":return null;case"inf":return Number.POSITIVE_INFINITY;case"ninf":return Number.NEGATIVE_INFINITY;case"nan":return Number.NaN;case"list":return t.map(function(e){return e instanceof u?e:new u(e)});default:throw new n({message:"Type unknown"})}}function a(e,t){return"list"==e?t.map(function(e){return e.copy()}):t}function s(e){e=e.replace(/[^A-Za-z0-9\+\/]/g,"");for(var t,n,r=e.length,o=3*r+1>>2,a=new i.Uint8Array(o),s=0,u=0,l=0;l<r;l++)if(n=3&l,s|=c(e.charCodeAt(l))<<18-6*n,3==n||r-l==1){for(t=0;t<3&&u<o;t++,u++)a[u]=s>>>(16>>>t&24)&255;s=0}return a.buffer}function c(e){return e>64&&e<91?e-65:e>96&&e<123?e-71:e>47&&e<58?e+4:43==e?62:47==e?63:0}var u=function(e){e&&e.type?(this._type=e.type,this._value=o(this._type,e.value)):(this._type=r(e),this._value=o(this._type,e))};u.json={serialize:function(e){var t={};return t.type=e._type,["null","nan","inf","ninf"].indexOf(t.type)!=-1?t[t.type]=!0:"list"==t.type?t.list=e._value.map(u.json.serialize):t[t.type]=e._value,t},deserialize:function(e){var t={type:e.type};return"list"==e.type?t.value=e.list?e.list.map(u.json.deserialize):[]:["null","nan","inf","ninf"].indexOf(e.type)==-1&&(t.value=e[e.type]),new u(t)}},t.defineClass(u,{getType:function(){return this._type},valueOf:function(e){return e&&"binary"==this._type?s(this._value):"datetime"==this._type?new Date(this._value):this._value},toString:function(){return this._value.toString()},copy:function(){return new u({type:this._type,value:a(this._type,this._value)})},applyListOperation:function(e){var t=this.dryRun(e);if(t)throw new n({code:409,type:t});var i=e.getType(),r=e.getIndex(),o=this._value;switch(i){case"list_item_set":o[r]=e.getValue();break;case"list_item_move":var a=o[r],s=e.getNewIndex();r!=s&&(o.splice(r,1),o.splice(s,0,a));break;case"list_item_insert":o.splice(r,0,e.getValue());break;case"list_item_delete":o.splice(r,1)}return this},dryRun:function(e){var t=e.getType(),n=e.getIndex(),i=this._value;switch(t){case"list_item_set":if(n>=i.length||n<0)return"incorrect_list_index";break;case"list_item_move":var r=e.getNewIndex();if(n>=i.length||n<0||r>=i.length||r<0)return"incorrect_list_index";break;case"list_item_insert":if(n>i.length||n<0)return"incorrect_list_index";break;case"list_item_delete":if(n>=i.length||n<0)return"incorrect_list_index";break;default:return"unknown_type"}return null}}),e(u)}),t.modules.define("cloud.dataSyncApi.config",function(e){e({apiHost:"https://cloud-api.yandex.net/",contexts:{app:!0,user:!0},oauthLoginPage:"https://oauth.yandex.ru/authorize?response_type=token&client_id={{ key }}",oauthWindowParameters:"width=600,height=500",prefix:"yandex_data_sync_api_v1",deltaLimit:100,backgroundSyncInterval:5e3})}),t.modules.define("cloud.dataSyncApi.http",["cloud.dataSyncApi.config","cloud.client","component.xhr","component.util","global","vow","cloud.Error"],function(e,t,n,i,r,o,a,s){var c=function(e){return e?u(e.context)?null:l("Invalid `options.context` Value"):l("`options` Parameter Required")},u=function(e){return e&&t.contexts[e]},l=function(e,t){return t||(t=e,e=400),a.reject(new s({code:e,message:t}))},d=function(e,t){var i=r.extend({},t);return i.headers?i.headers=r.extend({},i.headers):i.headers={},e.token?(i.headers.Authorization="OAuth "+e.token,a.resolve(i)):n.isInitialized()?(n.withCredentials()?i.withCredentials=!0:i.headers.Authorization="OAuth "+n.getToken(),a.resolve(i)):e&&(e.authorize_if_needed||"undefined"==typeof e.authorize_if_needed)?n.initialize(e).then(function(){return n.withCredentials()?i.withCredentials=!0:i.headers.Authorization="OAuth "+n.getToken(),i}):a.reject(new s({code:401}))};e({getDatabases:function(e){var n,r=t.apiHost+"v1/data/"+e.context+"/databases";return e&&e.database_id?r+="/"+e.database_id:n={limit:Number(e&&e.limit),offset:Number(e&&e.offset)},c(e)||d(e,{queryParams:n,parse:!0}).then(function(e){return i(r,e)})},putDatabase:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=l("`options.database_id` Parameter Required")),n||d(e,{method:"PUT",parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id,n)})},deleteDatabase:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=l("`options.database_id` Parameter Required")),n||d(e,{method:"DELETE",parse:!1}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id,n)})},getSnapshot:function(e){return c(e)||d(e,{parse:!0,queryParams:{collection_id:e&&e.collection_id}}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/snapshot",n)})},getDeltas:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=l("`options.database_id` Parameter Required")),n||"number"==typeof e.base_revision||(n=l("`options.base_revision` Parameter Required")),n||d(e,{method:"GET",queryParams:{base_revision:e.base_revision,limit:"undefined"==typeof e.limit?100:e.limit},parse:!0}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/deltas",n)})},postDeltas:function(e){var n=c(e);return n||"string"==typeof e.database_id||(n=l("`options.database_id` Parameter Required")),n||"number"==typeof e.base_revision||(n=l("`options.base_revision` Parameter Required")),n||"object"==typeof e.data||(n=l("`options.data` Parameter Required")),n||d(e,{method:"POST",headers:{"If-Match":e.base_revision},parse:!0,data:e.data}).then(function(n){return i(t.apiHost+"v1/data/"+e.context+"/databases/"+e.database_id+"/deltas",n)})},subscribe:function(e){return d(e,{parse:!0}).then(function(n){return i(t.apiHost+"v1/data/subscriptions/web?databases_ids="+encodeURIComponent(e.database_ids.join(",")),n)})}})}),t.modules.define("cloud.dataSyncApi.politics",[],function(e){e({theirs:function(e,t){var n=t.reduce(function(e,t){return e[t.index]=!0,e},{}),i=[];return e.forEach(function(e,t){n[t]||i.push(e)}),i}})}),t.modules.define("cloud.dataSyncApi.watcher",["global","cloud.dataSyncApi.config","cloud.dataSyncApi.syncEngine.PushEngine","cloud.dataSyncApi.syncEngine.PollEngine"],function(e,t,n,i,r){var o={_engine:null,_restartTimeout:null,_databases:{},subscribe:function(e,t){var n=e.getContext()+":"+e.getDatabaseId(),i=!1;this._databases[n]||(i=!0),i&&(this.getEngine().addDatabase(e),this._databases[n]={database:e,callbacks:[]}),this._databases[n].callbacks.push(t)},unsubscribe:function(e,t){var n=e.getContext()+":"+e.getDatabaseId(),i=this._databases[n],r=!1,o=i?i.callbacks.indexOf(t):-1;o!=-1&&(i.callbacks.splice(o,1),i.callbacks.length||(delete this._databases[n],r=!0)),r&&this.getEngine().removeDatabase(e)},getEngine:function(){return this._engine||this.setupEngine(),this._engine},setupEngine:function(){this._restartTimeout&&(t.clearTimeout(this._restartTimeout),this._restartTimeout=null),this._engine=this.createEngine(this._onUpdate.bind(this),this._onEngineFail.bind(this));var e=this._databases,n=Object.keys(e);n.length&&this._engine.addDatabase(n.map(function(t){return e[t].database}))},createEngine:function(e,t){var n=i.isSupported()?i:r;return new n({onUpdate:e,onFail:t})},teardownEngine:function(){this._engine&&(this._engine.removeAll(),this._engine=null)},_onUpdate:function(e,t){var n=this._databases[e];n.database.getRevision()!=t&&n.callbacks.slice().forEach(function(e){try{e(t)}catch(n){}})},_onEngineFail:function(){this.teardownEngine(),this._restartTimeout||(this._restartTimeout=t.setTimeout(function(){this._restartTimeout=null,this.setupEngine()}.bind(this),n.backgroundSyncInterval))}};e(o)}),t.modules.define("cloud.dataSyncApi.cache",["localForage","vow","cloud.Error","cloud.dataSyncApi.config","cloud.dataSyncApi.Dataset"],function(e,t,n,i,r,o){function a(e,r){var a=r?{collection_id:r,collection_policy:"skip"}:null;return t.getItem(e).then(function(e){if(!e)return n.reject(new i({code:404}));try{e=o.json.deserialize(JSON.parse(e),a)}catch(t){return e=null,s.clear().always(function(){return n.reject(new i({code:500}))})}return e})}t.config({name:r.prefix,storeName:r.prefix});var s={getDatasetKey:function(e,t,n){return n?"dataset_"+e+"_"+t+"|"+n:"dataset_"+e+"_"+t},getDataset:function(e,t,n){return n?a(this.getDatasetKey(e,t,n),n).then(null,function(i){if(404==i.code)return a(this.getDatasetKey(e,t),n);throw i},this):a(this.getDatasetKey(e,t))},saveDataset:function(e,t,n){return this.saveItem(this.getDatasetKey(e,t,n.getCollectionId()),JSON.stringify(o.json.serialize(n)))},saveItem:function(e,r){return t.setItem(e,r).fail(function(){return s.clear().always(function(){return n.reject(new i({code:500}))})})},clear:function(){return t.clear()}};e(s)}),t.modules.define("cloud.dataSyncApi.syncEngine.AbstractEngine",["global","vow","component.util","cloud.dataSyncApi.http"],function(e,t,n,i,r){var o=function(e){this._options=e||{},this._databases={},this._cancelableCallbacks=[]};o.isSupported=function(){return!0},i.defineClass(o,{addDatabase:function(e){e=[].concat(e),e.forEach(function(e){this._databases[this.getDatabaseKey(e)]={database:e,lastKnownRevision:e.getRevision()}},this),this.restart()},removeDatabase:function(e){e=[].concat(e),e.forEach(function(e){delete this._databases[this.getDatabaseKey(e)]},this),this.restart()},removeAll:function(){this._databases={},this._cancelCallbacks()},getDatabases:function(){return this._databases},addFailableCallback:function(e){this._cancelableCallbacks.push(e)},removeFailableCallback:function(e){var t=this._cancelableCallbacks.indexOf(e);t!=-1&&this._cancelableCallbacks.splice(t,1)},restart:function(){this._cancelCallbacks()},fail:function(e){this._databases=[],this._cancelCallbacks(),this._options.onFail(e)},updateRevisions:function(){return n.all(Object.keys(this._databases).map(function(e){var t=this._databases[e].database,n=i.cancelableCallback(function(t){200!=t.code?this.fail(t):(this.removeFailableCallback(n),this.checkDatabaseRevision(e,t.data.revision))}.bind(this));return this.addFailableCallback(n),r.getDatabases({context:t.getContext(),database_id:t.getDatabaseId()}).then(n,this.fail,this)}.bind(this)))},checkDatabaseRevision:function(e,t){Number(this._databases[e].lastKnownRevision)<Number(t)&&(this._databases[e].lastKnownRevision=t,this._options.onUpdate(e,t))},getDatabaseKey:function(e){return e.getContext()+":"+e.getDatabaseId()},getOptions:function(){return this._options},_cancelCallbacks:function(){this._cancelableCallbacks.slice().forEach(function(e){e.cancel()}),this._cancelableCallbacks=[]}}),e(o)}),t.modules.define("cloud.dataSyncApi.syncEngine.PushEngine",["global","component.util","cloud.dataSyncApi.http","cloud.dataSyncApi.syncEngine.AbstractEngine","cloud.Error"],function(e,t,n,i,r,o){var a=function(e){a.superclass.constructor.call(this,e),this._getSubscriptionCallback=null};a.isSupported=function(){return"function"==typeof t.WebSocket},n.defineClass(a,r,{removeAll:function(){this._teardownSocket(),a.superclass.removeAll.call(this)},restart:function(){this._teardownSocket(),a.superclass.restart.call(this);var e=Object.keys(this.getDatabases());this._getSubscriptionCallback=n.cancelableCallback(function(e){this.removeFailableCallback(this._getSubscriptionCallback),this._getSubscriptionCallback=null,200==e.code?(this._setupSocket(e.data.href),this.updateRevisions()):this.fail(new o(e))}.bind(this)),this.addFailableCallback(this._getSubscriptionCallback),i.subscribe({database_ids:e}).then(this._getSubscriptionCallback,this._fail,this)},fail:function(e){this._teardownSocket(),a.superclass.fail.call(this,e)},_setupSocket:function(e){try{this._ws=new t.WebSocket(e.replace(/^http(s)?\:/,"wss:"))}catch(n){this._ws=null,this.fail(n)}this._ws&&(this._ws.onmessage=this._onPush.bind(this),this._ws.onerror=this.fail.bind(this))},_teardownSocket:function(){this._ws&&(this._ws.onmessage=this._ws.onerror=null,this._ws.close(),this._ws=null)},_onPush:function(e){var t=JSON.parse(e.data);if("datasync_database_changed"==t.operation){var n=JSON.parse(t.message);this.checkDatabaseRevision(n.context+":"+n.database_id,n.revision)}}}),e(a)}),t.modules.define("cloud.dataSyncApi.syncEngine.PollEngine",["global","component.util","cloud.dataSyncApi.config","cloud.dataSyncApi.syncEngine.AbstractEngine"],function(e,t,n,i,r){var o=function(e){o.superclass.constructor.call(this,e),this._updateTimeout=null};o.isSupported=function(){return!0},n.defineClass(o,r,{removeAll:function(){this._updateTimeout&&(t.clearTimeout(this._updateTimeout),this._updateTimeout=null),o.superclass.removeAll.call(this)},restart:function(){this._updateTimeout&&(t.clearTimeout(this._updateTimeout),this._updateTimeout=null),this.updateRevisions().then(function(){this._updateTimeout=t.setTimeout(this.restart.bind(this),this.getOptions().backgroundSyncInterval||i.backgroundSyncInterval)},this)},fail:function(e){this._updateTimeout&&(t.clearTimeout(this._updateTimeout),this._updateTimeout=null),o.superclass.fail.call(this,e)}}),e(o)}),t.modules.define("global",function(t){t(e)}),"object"==typeof e.module)e.module.exports=t;else{var i=e.ya||(e.ya={modules:t.modules,vow:t.vow});i.cloud=t.cloud}}(this);